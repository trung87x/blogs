===========================================
ğŸ§© Ngá»¯ cáº£nh #4: Sinh JWT Token & xÃ¡c thá»±c
===========================================

ğŸ§  MÃ´ hÃ¬nh (Model) â€“ Ã nghÄ©a:
Sau khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p thÃ nh cÃ´ng, backend sáº½ táº¡o má»™t JWT token Ä‘áº¡i diá»‡n cho user Ä‘Ã³.

Token nÃ y sáº½ Ä‘Æ°á»£c client lÆ°u láº¡i (localStorage hoáº·c cookie)  
â†’ vÃ  gá»­i kÃ¨m theo má»—i request sau nÃ y Ä‘á»ƒ xÃ¡c thá»±c.

---

ğŸ” JWT (JSON Web Token) lÃ  gÃ¬?
LÃ  má»™t chuá»—i gá»“m 3 pháº§n: HEADER.PAYLOAD.SIGNATURE

VÃ­ dá»¥:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJ1c2VySWQiOiIxMjM0NTYifQ.
sD3vU3sAFkuXEi2h2skRRJSTyy_H7S8YGCr9Q1qef9g

---

ğŸ› ï¸ CÃ¡c bÆ°á»›c xá»­ lÃ½:
1. ÄÄƒng nháº­p thÃ nh cÃ´ng â†’ táº¡o token báº±ng `jwt.sign()`
2. Token chá»©a thÃ´ng tin user: `_id`, email...
3. Gá»­i token vá» client â†’ client lÆ°u
4. Client gá»­i token kÃ¨m má»—i láº§n gá»i API
5. Backend dÃ¹ng middleware `jwt.verify()` Ä‘á»ƒ xÃ¡c thá»±c

---

ğŸ“¦ CÃ i Ä‘áº·t thÆ° viá»‡n:
npm install jsonwebtoken

---

ğŸ“„ Táº¡o token á»Ÿ bÆ°á»›c Ä‘Äƒng nháº­p:
-----------------------------------
const jwt = require('jsonwebtoken');

const token = jwt.sign(
  { userId: user._id, email: user.email },
  process.env.JWT_SECRET || 'SECRET_KEY',
  { expiresIn: '1h' }
);

res.json({
  message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng',
  token
});

---

ğŸ“„ File middleware/verifyToken.js
-----------------------------------
const jwt = require('jsonwebtoken');

function verifyToken(req, res, next) {
  const authHeader = req.headers.authorization;

  // KhÃ´ng cÃ³ header
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ message: 'KhÃ´ng cÃ³ token, tá»« chá»‘i truy cáº­p' });
  }

  const token = authHeader.split(' ')[1];

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET || 'SECRET_KEY');
    req.user = decoded;
    next();
  } catch (err) {
    return res.status(403).json({ message: 'Token khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n' });
  }
}

module.exports = verifyToken;

---

ğŸ“„ Gáº¯n middleware vÃ o route cáº§n xÃ¡c thá»±c:
-----------------------------------
const verifyToken = require('../middleware/verifyToken');

router.get('/profile', verifyToken, async (req, res) => {
  res.json({
    message: 'ÄÃ£ xÃ¡c thá»±c thÃ nh cÃ´ng',
    user: req.user
  });
});

---

ğŸ“Œ GHI CHÃš QUAN TRá»ŒNG:

âœ… Client gá»­i token trong header nhÆ° sau:
Authorization: Bearer <token>

âœ… NÃªn cÃ³ háº¡n cho token (expiresIn: '1h', '7d'...)

âœ… KhÃ´ng lÆ°u JWT vÃ o database (trá»« khi dÃ¹ng refresh token)

âœ… Äá»«ng decode token thá»§ cÃ´ng báº±ng `atob()`  
â†’ LuÃ´n dÃ¹ng `jwt.verify()` Ä‘á»ƒ Ä‘áº£m báº£o chá»¯ kÃ½ há»£p lá»‡

âœ… SECRET_KEY nÃªn Ä‘Æ°á»£c cáº¥u hÃ¬nh trong file .env:
JWT_SECRET=your-super-secret-key