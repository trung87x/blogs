ğŸ§  Ngá»¯ cáº£nh #10: QuÃªn máº­t kháº©u / Reset password
â†’ Cho phÃ©p ngÆ°á»i dÃ¹ng reset máº­t kháº©u qua email, thÃ´ng qua token xÃ¡c thá»±c cÃ³ thá»i háº¡n.

ğŸ“ Gá»£i Ã½ cÃ¡c file:
- controllers/authController.js â†’ Xá»­ lÃ½ logic gá»­i mail vÃ  reset
- routes/auth.js â†’ Táº¡o 2 endpoint:
    POST /forgot-password
    POST /reset-password/:token
- models/User.js â†’ LÆ°u token reset vÃ  thá»i háº¡n vÃ o DB

===============================
ğŸ“„ MÃ´ hÃ¬nh Ä‘Æ¡n giáº£n hoÃ¡:
===============================

// 1. Gá»­i email chá»©a link reset password
// controllers/authController.js
const crypto = require('crypto');
const User = require('../models/User');
const sendEmail = require('../utils/sendEmail');

exports.forgotPassword = async (req, res) => {
  const { email } = req.body;
  const user = await User.findOne({ email });

  if (!user) return res.status(404).json({ message: 'Email khÃ´ng tá»“n táº¡i' });

  const resetToken = crypto.randomBytes(32).toString('hex');
  const hashedToken = crypto.createHash('sha256').update(resetToken).digest('hex');

  user.resetPasswordToken = hashedToken;
  user.resetPasswordExpire = Date.now() + 15 * 60 * 1000; // 15 phÃºt
  await user.save();

  const resetUrl = `http://localhost:3000/reset-password/${resetToken}`;
  await sendEmail(user.email, 'Reset Password', `Click vÃ o link sau Ä‘á»ƒ reset: ${resetUrl}`);

  res.json({ message: 'ÄÃ£ gá»­i email reset password' });
};

// 2. Reset máº­t kháº©u
exports.resetPassword = async (req, res) => {
  const hashedToken = crypto.createHash('sha256').update(req.params.token).digest('hex');
  const user = await User.findOne({
    resetPasswordToken: hashedToken,
    resetPasswordExpire: { $gt: Date.now() }
  });

  if (!user) return res.status(400).json({ message: 'Token khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n' });

  user.password = req.body.password;
  user.resetPasswordToken = undefined;
  user.resetPasswordExpire = undefined;
  await user.save();

  res.json({ message: 'Reset máº­t kháº©u thÃ nh cÃ´ng' });
};

===============================
ğŸ“„ Model user cáº§n thÃªm:
===============================
// models/User.js
resetPasswordToken: String,
resetPasswordExpire: Date

===============================
ğŸ“„ Route sá»­ dá»¥ng:
===============================
router.post('/forgot-password', forgotPassword);
router.post('/reset-password/:token', resetPassword);

===============================
ğŸ“Œ Ghi chÃº quan trá»ng:
===============================
âœ… Token reset pháº£i Ä‘Æ°á»£c mÃ£ hoÃ¡ vÃ  cÃ³ thá»i háº¡n
âœ… Gá»­i mail nÃªn cÃ³ domain tháº­t trong sáº£n pháº©m (sá»­ dá»¥ng dá»‹ch vá»¥ nhÆ° Mailtrap, SendGrid, Resend...)
âœ… Khi reset xong, xoÃ¡ token vÃ  thá»i háº¡n khá»i DB
âœ… Náº¿u muá»‘n báº£o máº­t cao, nÃªn táº¡o resetToken phá»©c táº¡p, ngáº¯n háº¡n vÃ  giá»›i háº¡n sá»‘ láº§n dÃ¹ng
