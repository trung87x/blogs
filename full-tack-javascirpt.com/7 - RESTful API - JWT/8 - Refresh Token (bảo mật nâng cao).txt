ðŸ§  Ngá»¯ cáº£nh #8: Refresh Token (báº£o máº­t nÃ¢ng cao)
â†’ DÃ¹ng Ä‘á»ƒ cáº¥p láº¡i access token khi token cÅ© háº¿t háº¡n, giÃºp ngÆ°á»i dÃ¹ng khÃ´ng bá»‹ Ä‘Äƒng xuáº¥t liÃªn tá»¥c.

ðŸ“ Gá»£i Ã½ cÃ¡c file liÃªn quan:
- middlewares/verifyToken.js      â†’ kiá»ƒm tra access token
- routes/auth.js                  â†’ route cáº¥p láº¡i access token
- models/RefreshToken.js (tÃ¹y chá»n) â†’ náº¿u muá»‘n lÆ°u refresh token vÃ o DB

===============================
ðŸ”‘ Kiáº¿n trÃºc tá»•ng quan:
===============================
1. Khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng:
   - Backend táº¡o 2 loáº¡i token:
     âœ… Access Token (ngáº¯n háº¡n â€“ vÃ­ dá»¥ 15 phÃºt)
     âœ… Refresh Token (dÃ i háº¡n â€“ vÃ­ dá»¥ 7 ngÃ y)

2. Access Token dÃ¹ng Ä‘á»ƒ truy cáº­p API nhÆ° bÃ¬nh thÆ°á»ng
3. Khi Access Token háº¿t háº¡n â†’ Client dÃ¹ng Refresh Token Ä‘á»ƒ gá»i API `/refresh`
4. Náº¿u Refresh Token há»£p lá»‡ â†’ Backend cáº¥p Access Token má»›i

===============================
ðŸ“„ ÄÄƒng nháº­p: táº¡o vÃ  gá»­i 2 token
===============================
const jwt = require('jsonwebtoken');

const accessToken = jwt.sign(
  { userId: user._id, role: user.role },
  process.env.ACCESS_TOKEN_SECRET,
  { expiresIn: '15m' }
);

const refreshToken = jwt.sign(
  { userId: user._id },
  process.env.REFRESH_TOKEN_SECRET,
  { expiresIn: '7d' }
);

// LÆ°u refreshToken vÃ o cookie
res.cookie('refreshToken', refreshToken, {
  httpOnly: true,
  secure: true,
  sameSite: 'Strict',
  maxAge: 7 * 24 * 60 * 60 * 1000
});

// Gá»­i access token vá» cho client
res.json({ accessToken });

===============================
ðŸ“„ Route: /refresh â€“ cáº¥p láº¡i access token
===============================
// routes/auth.js
router.post('/refresh', (req, res) => {
  const token = req.cookies.refreshToken;
  if (!token) return res.status(401).json({ message: 'No refresh token' });

  try {
    const payload = jwt.verify(token, process.env.REFRESH_TOKEN_SECRET);

    const newAccessToken = jwt.sign(
      { userId: payload.userId },
      process.env.ACCESS_TOKEN_SECRET,
      { expiresIn: '15m' }
    );

    res.json({ accessToken: newAccessToken });
  } catch (err) {
    res.status(403).json({ message: 'Invalid or expired refresh token' });
  }
});

===============================
ðŸ“„ Middleware kiá»ƒm tra access token (cÅ©):
===============================
const verifyToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  if (!token) return res.sendStatus(401);

  jwt.verify(token, process.env.ACCESS_TOKEN_SECRET, (err, decoded) => {
    if (err) return res.sendStatus(403);
    req.user = decoded;
    next();
  });
};

===============================
ðŸ“Œ Ghi chÃº quan trá»ng:
===============================
âœ… Access Token:
- Ngáº¯n háº¡n, dá»… háº¿t háº¡n, dÃ¹ng Ä‘á»ƒ báº£o vá»‡ API

âœ… Refresh Token:
- DÃ i háº¡n, nÃªn Ä‘Æ°á»£c lÆ°u trong cookie (httpOnly) Ä‘á»ƒ trÃ¡nh XSS
- KhÃ´ng nÃªn lÆ°u vÃ o localStorage

âœ… KhÃ´ng tÃ¡i sá»­ dá»¥ng Access Token háº¿t háº¡n â†’ luÃ´n gá»i /refresh

âœ… CÃ³ thá»ƒ lÆ°u refreshToken vÃ o DB náº¿u muá»‘n há»— trá»£ logout hoáº·c thu há»“i thá»§ cÃ´ng

âœ… NÃªn táº¡o route /logout Ä‘á»ƒ xÃ³a refreshToken khá»i cookie

===============================
ðŸ“„ Route /logout â€“ xoÃ¡ refreshToken:
===============================
router.post('/logout', (req, res) => {
  res.clearCookie('refreshToken');
  res.json({ message: 'Logged out successfully' });
});
