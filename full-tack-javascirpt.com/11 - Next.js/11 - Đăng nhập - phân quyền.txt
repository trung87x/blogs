ğŸ§  Model 11: ÄÄƒng nháº­p / phÃ¢n quyá»n
-------------------------------------
â€¢ Vai trÃ²: XÃ¡c thá»±c ngÆ°á»i dÃ¹ng, phÃ¢n quyá»n theo role (admin, user...), báº£o vá»‡ ná»™i dung riÃªng tÆ°.
â€¢ Controller: Káº¿t há»£p NextAuth.js, JWT, middleware Ä‘á»ƒ xá»­ lÃ½ xÃ¡c thá»±c vÃ  phÃ¢n quyá»n.

ğŸ“˜ Ngá»¯ cáº£nh #11: Há»‡ thá»‘ng Ä‘Äƒng nháº­p vÃ  phÃ¢n quyá»n cÆ¡ báº£n vá»›i NextAuth.js + JWT
-------------------------------------------------------------------------------

ğŸ“¦ 1. CÃ i Ä‘áº·t thÆ° viá»‡n:

```bash
npm install next-auth
```

ğŸ“ 2. Cáº¥u trÃºc thÆ° má»¥c:

```
/app
  /api
    /auth
      [...nextauth]/route.ts      â† route xÃ¡c thá»±c
  /admin
    /page.tsx                     â† chá»‰ cho admin truy cáº­p
  /user
    /page.tsx                     â† chá»‰ cho user Ä‘Ã£ Ä‘Äƒng nháº­p
/middleware.ts                    â† kiá»ƒm tra token & phÃ¢n quyá»n
/lib/auth.ts                      â† hÃ m kiá»ƒm tra role
```

ğŸ› ï¸ 3. Cáº¥u hÃ¬nh NextAuth: `app/api/auth/[...nextauth]/route.ts`

```ts
import NextAuth from 'next-auth'
import CredentialsProvider from 'next-auth/providers/credentials'

const handler = NextAuth({
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: "Email", type: "text" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        const { email, password } = credentials
        // TODO: kiá»ƒm tra email, password tá»« DB
        if (email === 'admin@abc.com' && password === 'admin') {
          return { id: '1', name: 'Admin', email, role: 'admin' }
        }
        if (email === 'user@abc.com' && password === 'user') {
          return { id: '2', name: 'User', email, role: 'user' }
        }
        return null
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) token.role = user.role
      return token
    },
    async session({ session, token }) {
      session.user.role = token.role
      return session
    }
  },
  secret: process.env.NEXTAUTH_SECRET,
})

export { handler as GET, handler as POST }
```

ğŸ” 4. Middleware kiá»ƒm tra phÃ¢n quyá»n: `middleware.ts`

```ts
import { NextResponse } from 'next/server'
import { getToken } from 'next-auth/jwt'

export async function middleware(req) {
  const token = await getToken({ req, secret: process.env.NEXTAUTH_SECRET })
  const { pathname } = req.nextUrl

  // Cháº·n náº¿u chÆ°a Ä‘Äƒng nháº­p
  if (pathname.startsWith('/user') && !token) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  // Cháº·n náº¿u khÃ´ng pháº£i admin
  if (pathname.startsWith('/admin') && token?.role !== 'admin') {
    return NextResponse.redirect(new URL('/unauthorized', req.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/user/:path*', '/admin/:path*'],
}
```

ğŸ“„ 5. Trang login: `app/login/page.tsx` (Ä‘Æ¡n giáº£n)

```tsx
'use client'
import { signIn } from 'next-auth/react'

export default function LoginPage() {
  return (
    <div>
      <h1>Login</h1>
      <button onClick={() => signIn('credentials', { email: 'admin@abc.com', password: 'admin' })}>
        ÄÄƒng nháº­p Admin
      </button>
    </div>
  )
}
```

ğŸ” 6. DÃ¹ng `useSession()` trong client Ä‘á»ƒ kiá»ƒm tra login:

```tsx
'use client'
import { useSession } from 'next-auth/react'

export default function UserPage() {
  const { data: session } = useSession()
  if (!session) return <p>Vui lÃ²ng Ä‘Äƒng nháº­p</p>
  return <p>ChÃ o {session.user.name}, báº¡n lÃ  {session.user.role}</p>
}
```

âœ… Káº¿t luáº­n:
- XÃ¡c thá»±c vÃ  phÃ¢n quyá»n trong Next.js ráº¥t máº¡nh khi káº¿t há»£p vá»›i NextAuth + Middleware.
- CÃ³ thá»ƒ dÃ¹ng role Ä‘á»ƒ kiá»ƒm soÃ¡t quyá»n xem tá»«ng trang.
- CÃ³ thá»ƒ má»Ÿ rá»™ng phÃ¢n quyá»n theo nhiá»u cáº¥p (admin, editor, guest...).

