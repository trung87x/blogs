ğŸ§  Model 9: Báº£o vá»‡ route, kiá»ƒm tra login
----------------------------------------
â€¢ Vai trÃ²: NgÄƒn cháº·n truy cáº­p trÃ¡i phÃ©p vÃ o cÃ¡c trang cáº§n Ä‘Äƒng nháº­p.
â€¢ Controller: DÃ¹ng Middleware (`middleware.ts`) Ä‘á»ƒ kiá»ƒm tra JWT hoáº·c session trÆ°á»›c khi cho phÃ©p truy cáº­p.

ğŸ” Ngá»¯ cáº£nh #9: Chá»‰ cho phÃ©p user Ä‘Ã£ Ä‘Äƒng nháº­p truy cáº­p `/dashboard`
---------------------------------------------------------------------
â€¢ Má»¥c tiÃªu: Náº¿u chÆ°a Ä‘Äƒng nháº­p â†’ chuyá»ƒn vá» `/login`, náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p â†’ cho vÃ o `/dashboard`.

ğŸ›¡ï¸ 1. Cáº¥u hÃ¬nh middleware kiá»ƒm tra token

```ts
// middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const token = request.cookies.get('token')?.value

  // Náº¿u khÃ´ng cÃ³ token, chuyá»ƒn hÆ°á»›ng vá» trang Ä‘Äƒng nháº­p
  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // CÃ³ token, tiáº¿p tá»¥c truy cáº­p
  return NextResponse.next()
}

// Ãp dá»¥ng middleware cho cÃ¡c route cáº§n báº£o vá»‡
export const config = {
  matcher: ['/dashboard/:path*'], // báº£o vá»‡ má»i route con cá»§a /dashboard
}
```

ğŸ”‘ 2. Äáº·t cookie "token" sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng

```ts
// app/api/login/route.ts (vÃ­ dá»¥ login)
import { NextResponse } from 'next/server'

export async function POST(request: Request) {
  const { email, password } = await request.json()

  // âš ï¸ Giáº£ Ä‘á»‹nh user há»£p lá»‡
  const isValidUser = email === 'admin@gmail.com' && password === '123456'

  if (!isValidUser) {
    return NextResponse.json({ message: 'Sai thÃ´ng tin Ä‘Äƒng nháº­p' }, { status: 401 })
  }

  // Táº¡o response vÃ  set cookie
  const response = NextResponse.json({ message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng' })
  response.cookies.set('token', 'fake-jwt-token', {
    httpOnly: true,
    path: '/',
  })

  return response
}
```

ğŸ 3. Giao diá»‡n /dashboard (náº¿u vÃ o Ä‘Æ°á»£c tá»©c lÃ  Ä‘Ã£ cÃ³ token)

```tsx
// app/dashboard/page.tsx
export default function DashboardPage() {
  return <h1>ChÃ o má»«ng Ä‘áº¿n trang quáº£n trá»‹!</h1>
}
```

ğŸ“Œ 4. Giao diá»‡n Ä‘Äƒng nháº­p Ä‘Æ¡n giáº£n (client-side)

```tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const router = useRouter()

  const handleLogin = async () => {
    const res = await fetch('/api/login', {
      method: 'POST',
      body: JSON.stringify({ email, password }),
      headers: { 'Content-Type': 'application/json' },
    })

    if (res.ok) {
      router.push('/dashboard')
    } else {
      alert('Sai tÃ i khoáº£n hoáº·c máº­t kháº©u')
    }
  }

  return (
    <div>
      <h2>ÄÄƒng nháº­p</h2>
      <input placeholder="Email" onChange={e => setEmail(e.target.value)} />
      <input placeholder="Máº­t kháº©u" type="password" onChange={e => setPassword(e.target.value)} />
      <button onClick={handleLogin}>ÄÄƒng nháº­p</button>
    </div>
  )
}
```

âœ… Káº¿t quáº£:
- Truy cáº­p `/dashboard` khi chÆ°a cÃ³ cookie `token` sáº½ bá»‹ redirect vá» `/login`.
- Sau khi Ä‘Äƒng nháº­p, cookie `token` Ä‘Æ°á»£c set, truy cáº­p `/dashboard` thÃ nh cÃ´ng.

ğŸ“š Ghi nhá»›:
- Middleware Next.js cháº¡y **trÆ°á»›c khi render trang** â†’ phÃ¹ há»£p báº£o vá»‡ route.
- DÃ¹ng `request.cookies.get()` Ä‘á»ƒ Ä‘á»c cookie.
- CÃ³ thá»ƒ káº¿t há»£p NextAuth, JWT tháº­t sá»± Ä‘á»ƒ báº£o máº­t cao hÆ¡n.

ğŸ§  Má»Ÿ rá»™ng:
- Kiá»ƒm tra token há»£p lá»‡ (giáº£i mÃ£ JWT).
- Gáº¯n role Ä‘á»ƒ phÃ¢n quyá»n nÃ¢ng cao.
- Háº¿t háº¡n token tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng logout.

