ğŸ“¦ Ngá»¯ cáº£nh #8: So sÃ¡nh máº­t kháº©u khi Ä‘Äƒng nháº­p (MongoDB + Mongoose + bcrypt)

ğŸ§  Model (Ã nghÄ©a)
- Khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p, cáº§n so sÃ¡nh máº­t kháº©u há» nháº­p (plain) vá»›i máº­t kháº©u Ä‘Ã£ hash trong DB.
- KhÃ´ng thá»ƒ so sÃ¡nh trá»±c tiáº¿p (vÃ¬ Ä‘Ã£ mÃ£ hÃ³a 1 chiá»u), nÃªn dÃ¹ng `bcrypt.compare`.

ğŸ› ï¸ Controller (CÃ´ng cá»¥ / CÃ¢u lá»‡nh)
- `bcrypt.compare(plainPassword, hashedPassword)` â†’ tráº£ vá» true/false
- NÃªn viáº¿t hÃ m riÃªng trong model Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng dá»… dÃ ng

ğŸ§ª Example (models/User.js)
const mongoose = require('mongoose');
const bcrypt = require('bcrypt');

const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true }
});

// ThÃªm phÆ°Æ¡ng thá»©c vÃ o schema
userSchema.methods.comparePassword = async function (inputPassword) {
  return await bcrypt.compare(inputPassword, this.password);
};

const User = mongoose.model('User', userSchema);
module.exports = User;

ğŸ§ª Example (routes/authRoute.js)
const express = require('express');
const User = require('../models/User');
const router = express.Router();

// POST /login - ÄÄƒng nháº­p user
router.post('/login', async (req, res) => {
  const { email, password } = req.body;

  try {
    const user = await User.findOne({ email });
    if (!user) return res.status(400).json({ error: 'Email khÃ´ng Ä‘Ãºng' });

    const isMatch = await user.comparePassword(password);
    if (!isMatch) return res.status(400).json({ error: 'Máº­t kháº©u khÃ´ng Ä‘Ãºng' });

    res.json({ message: 'ÄÄƒng nháº­p thÃ nh cÃ´ng' });
  } catch (err) {
    res.status(500).json({ error: 'Lá»—i há»‡ thá»‘ng' });
  }
});

module.exports = router;

ğŸ“ Ghi chÃº:
- KhÃ´ng nÃªn tráº£ lá»—i "sai email hay máº­t kháº©u" cá»¥ thá»ƒ â†’ lÃ½ do báº£o máº­t
- CÃ³ thá»ƒ táº¡o token (JWT) táº¡i Ä‘Ã¢y náº¿u Ä‘Äƒng nháº­p thÃ nh cÃ´ng
