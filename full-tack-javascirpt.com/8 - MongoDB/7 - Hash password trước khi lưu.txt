ğŸ“¦ Ngá»¯ cáº£nh #7: Hash password trÆ°á»›c khi lÆ°u (MongoDB + Mongoose + bcrypt)

ğŸ§  Model (Ã nghÄ©a)
- Äá»ƒ báº£o máº­t, máº­t kháº©u khÃ´ng Ä‘Æ°á»£c lÆ°u dÆ°á»›i dáº¡ng vÄƒn báº£n thuáº§n (plain text).
- TrÆ°á»›c khi lÆ°u vÃ o database, ta pháº£i "mÃ£ hoÃ¡ má»™t chiá»u" (hash).
- Viá»‡c nÃ y thÆ°á»ng xá»­ lÃ½ á»Ÿ táº§ng Model (trong `schema.pre('save')`)

ğŸ› ï¸ Controller (CÃ´ng cá»¥ / CÃ¢u lá»‡nh)
- `bcrypt.hash(plainPassword, saltRounds)`
- DÃ¹ng `schema.pre('save', async function(next) {...})` Ä‘á»ƒ xá»­ lÃ½ trÆ°á»›c khi lÆ°u
- `this.isModified('password')` giÃºp trÃ¡nh hash láº¡i khi khÃ´ng thay Ä‘á»•i

ğŸ§ª Example (models/User.js)
const mongoose = require('mongoose');
const bcrypt = require('bcrypt');

const userSchema = new mongoose.Schema({
  name: String,
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  createdAt: { type: Date, default: Date.now },
});

// Middleware: Hash password trÆ°á»›c khi lÆ°u
userSchema.pre('save', async function (next) {
  if (!this.isModified('password')) return next(); // bá» qua náº¿u khÃ´ng sá»­a password

  try {
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
    next();
  } catch (err) {
    next(err);
  }
});

const User = mongoose.model('User', userSchema);
module.exports = User;

ğŸ“ Ghi chÃº:
- `bcrypt.genSalt(10)`: táº¡o salt vá»›i Ä‘á»™ máº¡nh 10 vÃ²ng láº·p
- KhÃ´ng nÃªn hash láº¡i náº¿u password khÃ´ng thay Ä‘á»•i (giÃºp update user khÃ´ng bá»‹ lá»—i)
- Dá»¯ liá»‡u khi lÆ°u vÃ o DB sáº½ lÃ  chuá»—i hash khÃ´ng thá»ƒ Ä‘áº£o ngÆ°á»£c
